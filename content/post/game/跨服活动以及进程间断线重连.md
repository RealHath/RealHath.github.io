---
title: 跨服活动以及进程间断线重连
description: 跨服活动以及进程间断线重连
date: 2023-09-11
categories: ["游戏"]
tags: ["游戏"]

draft: true
---

# 服务器架构

- gateway进程：用于玩家连接登录和作为网关处理玩家socket信息和进程间rpc信息
- user进程：用于玩家游戏数据的保存，包括背包数据等，以及一些副本信息
- center：单服玩法，公会，竞技场，邮件，聊天
- map：副本，场景的战斗都在这。
- cross_gateway：用于路由，通常这个跨服网关进程上层有多个跨服节点，下层有多个单服节点，需要将上下层进程一一对应。
- cross_map, cross_center：跨服进程，用于活动等玩法。
- statistic: 

![服务器架构](/note/服务器架构.png)

# 进程间重连

## 单服进程

单服map，user，center是依赖单服gateway的，在启动的时候会监听`退出事件（自己封装的）`。进程间相互建立socket连接的时候会定时相互发送心跳包。

如果单服gateway退出进程，就会关闭所有socket连接，其他单服进程接超时收不到心跳包之后，认为socket断开连接。判断时候是gateway且是单服进程，满足条件就会发布`退出事件`，其他单服进程就会自动退出。

因为gateway是管理客户端连接的，如果gateway退出，那么其他单服也没有存在的必要，架构是这么设计。如果想要其他单服不退也可以，gateway退出之后其他单服需要把玩家登录信息清空，防止脏数据。

## 跨服进程

跨服进程不受单服影响，各个跨服进程不受`单服gateway退出事件`影响。进程退出之后，可以重新启动，然后从配置找到跨服节点的ip和port，重新建立tcp连接。

## 进程间连接

~~极端情况下两个进程几乎相同时间启动，然后读取配置的ip和port，向还没启动成功的进程建立连接，然后两个进程互相连接不上。~~ 

当进程启动的时候，肯定是先监听端口，然后再去发起tcp连接，不管怎样都是会有一个进程先监听端口完毕，先启动完毕的进程可能连接不上后启动完毕的进程，但是后启动完毕的进程一定能向前者发起连接。

# 跨服活动开启通知方式

## 消息转发



## a->b b->c异步问题



